<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toonkatha Post Generator</title>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- JSZip Library for ZIP file handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary-color: #4f46e5; --primary-hover: #4338ca; --secondary-color: #10b981; --secondary-hover: #059669;
            --text-color: #334155; --label-color: #475569; --bg-color: #f1f5f9; --container-bg: #ffffff;
           --border-color: #e2e8f0; --input-bg: #f8fafc; --danger-color: #ef4444; --warning-color: #f59e0b;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); display: flex; justify-content: center; padding: 2rem 1rem; }
        .container { width: 100%; max-width: 1000px; background-color: var(--container-bg); border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); overflow: hidden; }
        header { background-color: var(--primary-color); color: white; padding: 1.5rem; text-align: center; }
        header h1 { font-size: 1.75rem; font-weight: 600; }
        .main-nav { display: flex; border-bottom: 1px solid var(--border-color); }
        .nav-button { flex: 1; padding: 1rem; font-size: 1rem; font-weight: 500; cursor: pointer; border: none; background-color: transparent; color: var(--label-color); transition: all 0.2s ease-in-out; border-bottom: 3px solid transparent; }
        .nav-button:hover { background-color: #f8fafc; color: var(--primary-color); }
        .nav-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .generator-section { display: none; padding: 2rem; }
        .generator-section.active { display: block; }
        h2 { font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--text-color); text-align: center; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--label-color); }
        .input-with-button { display: flex; gap: 0.5rem; }
        input[type="text"], input[type="number"], textarea { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--input-bg); font-size: 1rem; color: var(--text-color); transition: border-color 0.2s, box-shadow 0.2s; }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); }
        textarea { min-height: 150px; resize: vertical; font-family: monospace; }
        .btn { padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: 500; cursor: pointer; border: none; border-radius: 8px; color: white; transition: background-color 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-primary { background-color: var(--primary-color); } .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: var(--secondary-color); } .btn-secondary:hover { background-color: var(--secondary-hover); }
        .search-results-grid { margin-top: 1.5rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .search-result-card { display: flex; gap: 1rem; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; background-color: var(--container-bg); }
        .search-result-card:hover { border-color: var(--primary-color); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .search-result-card img { width: 80px; height: 120px; object-fit: cover; border-radius: 4px; }
        .search-result-card-info h4 { margin: 0 0 0.5rem 0; font-size: 1.1rem; }
        .search-result-card-info p { margin: 0; font-size: 0.875rem; color: #64748b; line-height: 1.4; }
        .output-group { margin-top: 2rem; } .output-group h3 { font-size: 1.25rem; margin-bottom: 1rem; }
        .output-container { position: relative; }
        .copy-button { position: absolute; top: 0.5rem; right: 0.5rem; background-color: var(--label-color); color: white; padding: 0.5rem; border-radius: 6px; border:none; cursor:pointer; }
        .copy-button:hover { background-color: var(--text-color); }
        .upload-container { border: 2px dashed var(--border-color); border-radius: 12px; padding: 2rem; text-align: center; background-color: var(--input-bg); margin-bottom: 1.5rem; }
        .upload-container h4 { font-size: 1.25rem; margin-bottom: 1rem; }
        .upload-options { display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }
        input[type="file"] { display: none; }
        .upload-status { margin-top: 1.5rem; font-weight: 500; color: var(--primary-color); }
        #pageLinksContainer .input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        #pageLinksContainer .input-group input { flex-grow: 1; background-color: #eef2ff; }
    </style>
</head>
<body>
    <div class="container">
        <header><h1>Toonkatha Post Generator</h1></header>
        <nav class="main-nav">
            <button id="showPostBtn" class="nav-button active"><i class="fa-solid fa-file-invoice"></i> Create Main Post</button>
            <button id="showChapterBtn" class="nav-button"><i class="fa-solid fa-book-open"></i> Create Chapter Post</button>
        </nav>
        <main>
            <section id="postGenerator" class="generator-section active">
                <h2>Generate Main Post</h2>
                <div class="form-group"><label for="mangaSearchInput">Search Manga/Manhwa Title</label><div class="input-with-button"><input type="text" id="mangaSearchInput" placeholder="e.g., Solo Leveling"><button id="searchButton" class="btn btn-primary"><i class="fa-solid fa-magnifying-glass"></i> Search</button></div></div>
                <div id="searchResults" class="search-results-grid"></div>
                <div id="postOutputs" style="display: none;">
                    <div class="output-group"><h3>Generated Post Title</h3><div class="output-container"><textarea id="postTitleOutput" readonly></textarea><button class="copy-button" onclick="copyToClipboard('postTitleOutput')"><i class="fa-solid fa-copy"></i></button></div></div>
                    <div class="output-group"><h3>Generated Post HTML</h3><div class="output-container"><textarea id="postHtmlOutput" readonly></textarea><button class="copy-button" onclick="copyToClipboard('postHtmlOutput')"><i class="fa-solid fa-copy"></i></button></div></div>
                    <div class="output-group"><h3>Generated Labels</h3><div class="output-container"><textarea id="postLabelsOutput" readonly></textarea><button class="copy-button" onclick="copyToClipboard('postLabelsOutput')"><i class="fa-solid fa-copy"></i></button></div></div>
                </div>
            </section>

            <section id="chapterGenerator" class="generator-section">
                <h2>Generate Chapter Post</h2>
                <div class="form-group"><label for="mangaTitleForChapter">Main Manga Title (from previous step)</label><input type="text" id="mangaTitleForChapter" readonly></div>
                <div class="form-group"><label for="chapterNumberInput">Chapter Number</label><input type="number" id="chapterNumberInput" placeholder="e.g., 1"></div>
                
                <div class="upload-container">
                    <h4>Upload Chapter Pages</h4>
                    <div class="upload-options">
                        <label for="zipUploadInput" class="btn btn-primary"><i class="fa-solid fa-file-zipper"></i> Upload ZIP File</label>
                        <input type="file" id="zipUploadInput" accept=".zip">
                        
                        <label for="manualUploadInput" class="btn btn-secondary"><i class="fa-solid fa-images"></i> Upload Images Manually</label>
                        <input type="file" id="manualUploadInput" accept="image/*" multiple>
                    </div>
                     <div id="uploadStatus" class="upload-status"></div>
                </div>

                <div class="form-group">
                    <label>Uploaded Page Links</label>
                    <div id="pageLinksContainer"></div>
                </div>

                <button id="generateChapterCode" class="btn btn-secondary"><i class="fa-solid fa-wand-magic-sparkles"></i> Generate Code</button>
                <div id="chapterOutputs" style="display: none;">
                    <div class="output-group"><h3>Generated Post Title</h3><div class="output-container"><textarea id="chapterTitleOutput" readonly></textarea><button class="copy-button" onclick="copyToClipboard('chapterTitleOutput')"><i class="fa-solid fa-copy"></i></button></div></div>
                    <div class="output-group"><h3>Generated Post HTML</h3><div class="output-container"><textarea id="chapterHtmlOutput" readonly></textarea><button class="copy-button" onclick="copyToClipboard('chapterHtmlOutput')"><i class="fa-solid fa-copy"></i></button></div></div>
                    <div class="output-group"><h3>Generated Label</h3><div class="output-container"><textarea id="chapterLabelOutput" readonly></textarea><button class="copy-button" onclick="copyToClipboard('chapterLabelOutput')"><i class="fa-solid fa-copy"></i></button></div></div>
                </div>
            </section>
        </main>
    </div>
<script>
    // --- START: CONFIGURATION ---
    const IMGBB_API_KEY = "fb1fd853dd40775f6eba7cf52cf67a69";
    // --- END: CONFIGURATION ---

    // Global state
    let selectedMangaData = null;

    // DOM Elements
    const showPostBtn=document.getElementById("showPostBtn"),showChapterBtn=document.getElementById("showChapterBtn"),postGenerator=document.getElementById("postGenerator"),chapterGenerator=document.getElementById("chapterGenerator"),searchButton=document.getElementById("searchButton"),searchInput=document.getElementById("mangaSearchInput"),searchResults=document.getElementById("searchResults"),postOutputs=document.getElementById("postOutputs"),postTitleOutput=document.getElementById("postTitleOutput"),postHtmlOutput=document.getElementById("postHtmlOutput"),postLabelsOutput=document.getElementById("postLabelsOutput"),mangaTitleForChapter=document.getElementById("mangaTitleForChapter"),chapterNumberInput=document.getElementById("chapterNumberInput"),pageLinksContainer=document.getElementById("pageLinksContainer"),generateChapterCodeBtn=document.getElementById("generateChapterCode"),chapterOutputs=document.getElementById("chapterOutputs"),chapterTitleOutput=document.getElementById("chapterTitleOutput"),chapterHtmlOutput=document.getElementById("chapterHtmlOutput"),chapterLabelOutput=document.getElementById("chapterLabelOutput"),zipUploadInput=document.getElementById("zipUploadInput"),manualUploadInput=document.getElementById("manualUploadInput"),uploadStatus=document.getElementById("uploadStatus");

    // View Switching
    function switchView(e){"post"===e?(postGenerator.classList.add("active"),chapterGenerator.classList.remove("active"),showPostBtn.classList.add("active"),showChapterBtn.classList.remove("active")):(postGenerator.classList.remove("active"),chapterGenerator.classList.add("active"),showPostBtn.classList.remove("active"),showChapterBtn.classList.add("active"))}showPostBtn.addEventListener("click",()=>switchView("post")),showChapterBtn.addEventListener("click",()=>switchView("chapter"));
    
    // Main Post Logic
    searchButton.addEventListener("click",searchManga),searchInput.addEventListener("keypress",e=>{"Enter"===e.key&&searchManga()});
    async function searchManga(){const e=searchInput.value.trim();if(!e)return void alert("Please enter a search term.");searchResults.innerHTML='<div style="text-align:center;padding:20px;grid-column:1/-1;"><div class="loader"></div></div>';try{const t=await fetch(`https://api.jikan.moe/v4/manga?q=${encodeURIComponent(e)}&limit=10`),a=await t.json();displaySearchResults(a.data)}catch(e){searchResults.innerHTML="<p>Error fetching data.</p>",console.error("API Error:",e)}}
    function displaySearchResults(e){searchResults.innerHTML="",(!e||0===e.length)&&(searchResults.innerHTML="<p>No results found.</p>"),e.forEach(e=>{const t=document.createElement("div");t.className="search-result-card";const a=(e.synopsis||"").substring(0,120);t.innerHTML=`<img src="${e.images.jpg.image_url}" alt="Cover"><div class="search-result-card-info"><h4>${e.title}</h4><p>${a}...</p></div>`,t.addEventListener("click",()=>selectManga(e)),searchResults.appendChild(t)})}
    
    function selectManga(manga) {
        selectedMangaData = manga;
        mangaTitleForChapter.value = manga.title;
        postTitleOutput.value = manga.title;
        
        const synopsis = (manga.synopsis || "No synopsis available.");
        const author = manga.authors.length > 0 ? manga.authors[0].name : "Unknown";
        const releaseYear = manga.published.from ? new Date(manga.published.from).getFullYear() : "N/A";
        const coverUrl = manga.images.jpg.large_image_url || manga.images.jpg.image_url;
        
        postHtmlOutput.value = 
`<div class="separator" style="clear: both;"><a href="${coverUrl}" style="display: block; padding: 1em 0; text-align: center; "><img alt="Cover image for ${manga.title}" border="0" src="${coverUrl}"/></a></div>
<p id="syn_bod" style="white-space: pre-wrap">${synopsis}</p>   
<span id="tauther">${author}</span>
<span id="trelease">${releaseYear}</span>
<!-- chapter_set -->
<div class="chapter_get" data-labelchapter="${manga.title}"></div>`;
        
        const finalLabels = new Set();
        if (manga.status === 'Finished') finalLabels.add('Completed');
        else if (manga.status === 'Publishing') finalLabels.add('Ongoing');
        if (manga.type) finalLabels.add(manga.type);
        finalLabels.add('New');
        finalLabels.add('Series');
        manga.genres.forEach(g => finalLabels.add(g.name));
        manga.themes.forEach(t => finalLabels.add(t.name));
        finalLabels.add(manga.title);
        postLabelsOutput.value = Array.from(finalLabels).join(',');
        
        searchResults.innerHTML = `<p style="text-align:center;font-weight:500;color:var(--secondary-color);">Selected: ${manga.title}.</p>`;
        postOutputs.style.display = 'block';
    }

    // --- CHAPTER POST LOGIC (NEW & UPGRADED) ---

    // 1. Core Upload Function to ImgBB
    async function uploadToImgBB(file) {
        const formData = new FormData();
        formData.append('image', file);
        
        try {
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: 'POST',
                body: formData,
            });
            const result = await response.json();
            if (result.success) {
                return result.data.url;
            } else {
                throw new Error(result.error.message);
            }
        } catch (error) {
            console.error('ImgBB Upload Error:', error);
            return null; // Return null on failure
        }
    }

    // 2. Handle Manual File Upload
    manualUploadInput.addEventListener('change', (event) => {
        const files = Array.from(event.target.files);
        if (files.length > 0) {
            handleFileUpload(files);
        }
    });

    // 3. Handle ZIP File Upload
    zipUploadInput.addEventListener('change', async (event) => {
        const zipFile = event.target.files[0];
        if (!zipFile) return;

        pageLinksContainer.innerHTML = '';
        uploadStatus.textContent = 'Reading ZIP file... Please wait.';
        
        try {
            const jszip = new JSZip();
            const zip = await jszip.loadAsync(zipFile);
            
            const imageFiles = [];
            zip.forEach((relativePath, zipEntry) => {
                // Ignore directories and non-image files (like .DS_Store or __MACOSX)
                if (!zipEntry.dir && /\.(jpe?g|png|gif|webp)$/i.test(zipEntry.name)) {
                    imageFiles.push(zipEntry);
                }
            });

            // Natural sort to handle "1.jpg", "2.jpg", "10.jpg" correctly
            imageFiles.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));

            if (imageFiles.length === 0) {
                uploadStatus.style.color = 'var(--danger-color)';
                uploadStatus.textContent = 'No valid image files found in the ZIP.';
                return;
            }

            // Convert zip entries to file-like Blobs for uploading
            const filesToUpload = await Promise.all(
                imageFiles.map(async (zipEntry) => {
                    const blob = await zipEntry.async('blob');
                    return new File([blob], zipEntry.name, { type: blob.type });
                })
            );

            handleFileUpload(filesToUpload);

        } catch (error) {
            uploadStatus.style.color = 'var(--danger-color)';
            uploadStatus.textContent = 'Error processing ZIP file. It might be corrupted.';
            console.error('ZIP Error:', error);
        }
    });

    // 4. Master Function to Process and Upload Files
    async function handleFileUpload(files) {
        pageLinksContainer.innerHTML = '';
        uploadStatus.style.color = 'var(--primary-color)';
        
        const totalFiles = files.length;
        const uploadedUrls = [];

        for (let i = 0; i < totalFiles; i++) {
            const file = files[i];
            uploadStatus.textContent = `Uploading image ${i + 1} of ${totalFiles} (${file.name})...`;
            
            const url = await uploadToImgBB(file);
            
            if (url) {
                uploadedUrls.push(url);
            } else {
                uploadStatus.style.color = 'var(--danger-color)';
                uploadStatus.textContent = `Failed to upload ${file.name}. Please check the console and try again.`;
                return; // Stop on failure
            }
        }
        
        uploadStatus.style.color = 'var(--secondary-color)';
        uploadStatus.textContent = `Successfully uploaded ${totalFiles} images!`;
        populateLinkInputs(uploadedUrls);
    }
    
    // 5. Populate Link Inputs after Upload
    function populateLinkInputs(urls) {
        pageLinksContainer.innerHTML = '';
        urls.forEach((url, index) => {
            const newInputGroup = document.createElement('div');
            newInputGroup.className = 'input-group';
            newInputGroup.innerHTML = `<input type="text" class="page-link-input" value="${url}" readonly title="Page ${index + 1}">`;
            pageLinksContainer.appendChild(newInputGroup);
        });
    }


    // 6. Generate Final Chapter Code
    generateChapterCodeBtn.addEventListener("click", () => {
        const mainTitle = mangaTitleForChapter.value.trim();
        const chapterNum = chapterNumberInput.value.trim();

        if (!mainTitle) { alert('Please select a manga from the "Create Main Post" tab first.'); return; }
        if (!chapterNum) { alert('Please provide the Chapter Number.'); return; }
        
        const pageLinkInputs = document.querySelectorAll('.page-link-input');
        const pageLinks = Array.from(pageLinkInputs).map(input => input.value.trim()).filter(link => link);
        
        if (pageLinks.length === 0) { alert('Please upload images first to generate links.'); return; }

        let chapterHtml = '';
        pageLinks.forEach(link => {
            // Added lazy loading attribute and better alt text
            chapterHtml += `<div class="separator" style="clear: both; text-align: center;"><img alt="${mainTitle} Chapter ${chapterNum} Page" border="0" src="${link}" loading="lazy" /></div>\n`;
        });
        
        chapterTitleOutput.value = `${mainTitle} Chapter ${chapterNum}`;
        chapterHtmlOutput.value = chapterHtml.trim();
        chapterLabelOutput.value = `Chapter,${mainTitle}`;
        
        chapterOutputs.style.display = 'block';
    });
    
    // Utility function
    function copyToClipboard(e){
        const textarea = document.getElementById(e);
        textarea.select();
        document.execCommand('copy');
        // A slightly better feedback mechanism
        const originalText = textarea.value;
        const btn = textarea.nextElementSibling;
        const icon = btn.querySelector('i');
        icon.className = 'fa-solid fa-check';
        setTimeout(() => { icon.className = 'fa-solid fa-copy';}, 2000);
    }
</script>
</body>
</html>
